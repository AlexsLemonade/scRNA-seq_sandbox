---
title: "sample_id_convert"
author: "C. Savonen, CCDL for ALSF"
date: "12/12/2018"
output: html_document
---

```{r setup, include=FALSE}
#--------------------------- Create ID conversion key--------------------------#
# Get geo metadata
geo.meta <- GEOquery::getGEO(opt$geo, destdir = file.path(opt$output))
    
# Get the GSM and SRX ids from the GEO metadata
id.key <- data.frame(gsm.ids = geo.meta[[1]]@phenoData@data$geo_accession,
    plate.ids = geo.meta[[1]]@phenoData@data$description.1,
    srx.ids = stringr::word(geo.meta[[1]]@phenoData@data$relation.1,
                                              start = 2, sep = "term="))
    
# Import SRA file names
sra.files <- read.csv(file.path(opt$output, "SRA.files.csv"))[, -1]
    
# Merge both keys into a single id.key dataframe
id.key <- merge(id.key, sra.files, by.x = "srx.ids", by.y = "experiment")
    
# Save this dataframe for later
saveRDS(id.key, file = file.path(opt$output, "sample_id_key.RDS"))
    
# Save the rest of the metadata as a csv
geo.meta <- data.frame(geo.meta[[1]]@phenoData@data)
write.csv(geo.meta, file = file.path(opt$output, "meta_data.csv"))
    
id.key <- readRDS(file.path("anoop_data", "sample_id_key.RDS"))

#----------------------Change sample column names to GSM-----------------------#
# Make our SRA conversion key
convert.key <- as.list(as.character(id.key$gsm.ids))
names(convert.key) <- as.character(id.key$run)

# Obtain GSM ids using conversion key and make these the column names
colnames(salmon.data) <- dplyr::recode(colnames(salmon.data), !!!convert.key)
```
