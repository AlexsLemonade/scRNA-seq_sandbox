---
title: "Arnon_ASAP_data_prep"
author: "C. Savonen, CCDL for ALSF"
date: "12/6/2018"
output: html_document
---

<<<<<<< HEAD
## Purpose: Prep data for use in post-processing pipeline or in 
[ASAP online](https://asap.epfl.ch/)
```{r Import functions}
source(file.path("scripts", "util", "data_prep_functions.R"))
=======
## Purpose: Prep data for normalization by `5-run_normalization.R` or for use in
[ASAP online](https://asap.epfl.ch/)
```{r Import functions}
source(file.path("scripts", "util", "asap_prep_functions.R"))
>>>>>>> 268ad946d2caf0a5571ee50cf26da8af2f800be0
```

```{r Import data}
# Import gene expression matrix data
data <- read.csv(file.path("arnon_data", "GSE115978_counts.csv"))
```

### Import metadata
```{r Set up metadata}
if (file.exists(file.path("arnon_data", "meta_data.csv"))) {
# Read in csv if it's been made, if not read in from GEOquery
  geo.meta <- read.csv(file.path("arnon_data", "meta_data.csv"),
                       stringsAsFactors = FALSE)
} else {
  geo.meta <- GEOquery::getGEO("GSE115978", destdir = "arnon_data")
  geo.meta <- data.frame(geo.meta[[1]]@phenoData@data)
  readr::write_csv(geo.meta, file.path("arnon_data", "meta_data.csv"))
}
```

<<<<<<< HEAD
### Filtering genes and samples
=======

### ASAP only likes round numbers for the counts
>>>>>>> 268ad946d2caf0a5571ee50cf26da8af2f800be0
Filter out genes that don't have at least one count in 1% of cells and filter out 
samples that don't express at least 100 genes. This function assumes the first 
column holds the genes.
```{r Filter out genes}
<<<<<<< HEAD
prepped.data <- GeneMatrixFilter(data, min_counts = 1, perc_genes = 0.01,
                                 num_genes = 100)
=======
prepped.data <- AsapFilter(data, min_counts = 1, perc_genes = 0.01,
                           num_genes = 100)
>>>>>>> 268ad946d2caf0a5571ee50cf26da8af2f800be0
```

### Make sure the samples and the metadata are in the same order.
```{r Order samples}
# Put samples in same order 
geo.meta <- geo.meta[match(colnames(prepped.data)[-1], geo.meta$title), ]
```

<<<<<<< HEAD
### Make batch file if you want to correct by batches
In this case we will use the plate ids. 
If using ASAP, need the first column to be the sample IDs that match your sample 
data file and the second column to be the corresponding batch the sample belongs to.
=======
### Make batch file for ASAP to correct batches by.
In this case we will use the plate ids. 
ASAP wants the first column to be the sample IDs that match your sample data file
and the second column to be the corresponding batch the sample belongs to.
>>>>>>> 268ad946d2caf0a5571ee50cf26da8af2f800be0
```{r Make batch info}
batch.info <- cbind(geo.meta$geo_accession,
                    geo.meta$characteristics_ch1.2)
head(batch.info)
```

<<<<<<< HEAD
### Write counts data file
=======
### Write data file in the format ASAP will take.
ASAP wants a typical gene by column gene expression matrix with samples with 
the column names and the first column being the gene names.
You can use other forms of separation other than "/t" but will need to specify
what you have used in a drop down menu on ASAP. 
>>>>>>> 268ad946d2caf0a5571ee50cf26da8af2f800be0
```{r Write data file}
# Write a copy of the counts in the normalized data file
readr::write_tsv(prepped.data, file.path("arnon_data", "normalized_arnon", 
                                         "counts_arnon.tsv"))
<<<<<<< HEAD
=======

>>>>>>> 268ad946d2caf0a5571ee50cf26da8af2f800be0
```

### Write batch file in same type of format
```{r Write batch file}
# Write batch info file for ASAP use
readr::write_tsv(data.frame(batch.info), file.path("arnon_data",
                                                   "batch.info.txt"))
```
<<<<<<< HEAD

### Write metadata info to be used later
Keep only the metadata of interest (ones you would like to use to get clustering
statistics) in this file. Ideally you would test something biological like 
cell type and then something technical, like batch.
=======
### Write metadata info to be used later
>>>>>>> 268ad946d2caf0a5571ee50cf26da8af2f800be0
```{r Write batch file}
# Write metadata file for subsequent testing
geo.meta %>% dplyr::select("cell.type.ch1", "characteristics_ch1.2") %>%
             readr::write_tsv(file.path("arnon_data", "metadata.tsv"))
```
<<<<<<< HEAD

=======
>>>>>>> 268ad946d2caf0a5571ee50cf26da8af2f800be0
Session info: 
```{r}
sessionInfo()
```