---
title: "Seurat Data Processing"
author: "C.Savonen, CCDL for ALSF"
date: "12/5/2018"
output: html_document
---
### Purpose: Using Seurat for post-processing of scRNA-seq Salmon processed data
Adpated from the Seurat pbmc tutorial found [here](https://satijalab.org/seurat/pbmc3k_tutorial.html) 
```{r Install Packages}
# Get Seurat installed if it isn't already
if (!("Seurat" %in% installed.packages())) {
  install.packages("remotes")
  remotes::install_github("UCSF-TI/fake-hdf5r")
  install.packages('Seurat')
}
# Attach library
library(Seurat)
```

#### Import gene expression matrix data
```{r Import Data}
tx.counts <- readRDS(file.path("darmanis_data", "darmanis.counts.RDS"))
```

#### Mitochondrial genes by their ensembl IDs
This list is from [here](http://jdblischak.github.io/singleCellSeq/analysis/qc-filter-ipsc.html)
```{r Set up mitochondrial gene list}
# Identify mitochondrial genes by their ensembl IDs
mtgene <- c("ENSG00000198899", "ENSG00000198727", "ENSG00000198888", 
            "ENSG00000198886", "ENSG00000212907", "ENSG00000198786",
            "ENSG00000198695", "ENSG00000198712", "ENSG00000198804",
            "ENSG00000198763","ENSG00000228253", "ENSG00000198938", 
            "ENSG00000198840")

# Get the gene symbol names for these genes add regex for exact matches
mtgene <- tx.counts$gene[match(mtgene, tx.counts$ensembl)]
mtgene <- paste0("^", mtgene, "$")
```

#### Set up data in Seurat format
```{r Set Up Data into seurat format}
# Make our data into a Seurat Object
seurat <- CreateSeuratObject(raw.data = tx.counts, min.cells = 3,
                                    min.genes = 200, project = "darmanis_gbm")
```

#### Get mitochondrial gene percentages
```{r Calculate Mito Percentages}
# Get those mito genes
mito.genes <- grep(pattern = paste0(mtgene, collapse = "|"), 
                   x = rownames(seurat@data), value = TRUE)

# Calculate the percentage of mitochonrial transcripts to total transcripts
percent.mito <- Matrix::colSums(seurat@raw.data[mito.genes, ])/
  Matrix::colSums(seurat@raw.data)

# AddMetaData adds columns to object@meta.data, and is a great place to
# stash QC stats
seurat <- AddMetaData(object = seurat, metadata = percent.mito,
                             col.name = "percent_mito")
```

#### Normalize and filter data
From seurat tutorial: we employ a global-scaling normalization method “LogNormalize” 
that normalizes the gene expression measurements for each cell by the total expression,
multiplies this by a scale factor (10,000 by default), and log-transforms the result.
```{r Filter Normalize}
# Filter out cells
seurat <- FilterCells(object = seurat, 
                             subset.names = c("nGene", "percent_mito"), 
                             low.thresholds = c(200, -Inf), 
                             high.thresholds = c(2500, 0.05))

# Normalizing the data
seurat <- NormalizeData(object = seurat, 
                               normalization.method = "LogNormalize", 
                               scale.factor = 10000)
```

#### Save the normalized data
```{r Save Data to RDS}
# Save this seurat object to an RDS file
saveRDS(seurat, file = file.path("darmanis_data", "darmanis.seurat.norm.RDS"))
```

```{r}
sessionInfo()
```
